name: 'Scan Dockerfile Changes for CVE Differences'
description: 'Detects changed Dockerfiles via git diff and scans old vs new images for CVE comparison'

runs:
  using: 'composite'
  steps:
    - name: Detect Changed Dockerfiles and Scan CVEs
      shell: bash
      run: |
        set -euo pipefail
        
        # Function to output to both console and summary
        output() {
          echo "$@"
          echo "$@" >> $GITHUB_STEP_SUMMARY
        }
        
        output "# üìä CVE Comparison Report"
        output ""
        
        # Check if there are any changes
        if ! git diff --quiet HEAD; then
          output "‚úÖ Changes detected, analyzing..."
        else
          output "‚ÑπÔ∏è No changes detected"
          exit 0
        fi
        
        # Install grype if needed
        if ! command -v grype &> /dev/null; then
          output "üì• Installing Grype..."
          curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh -s -- -b "${GITHUB_WORKSPACE}/bin"
          export PATH="${GITHUB_WORKSPACE}/bin:$PATH"
        fi
        
        # Find all changed Dockerfiles
        CHANGED_FILES=$(git diff --name-only HEAD | grep -E '(Dockerfile|\.Dockerfile)$' || true)
        
        if [ -z "$CHANGED_FILES" ]; then
          output "‚ÑπÔ∏è No Dockerfile changes found"
          exit 0
        fi
        
        output "üì¶ Changed Dockerfiles:"
        output '```'
        output "$CHANGED_FILES"
        output '```'
        output ""
        
        # Process each Dockerfile
        while IFS= read -r dockerfile; do
          [ -z "$dockerfile" ] && continue
          
          output "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          output "üîç Processing: $dockerfile"
          output "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          output ""
          
          # Get the diff for this Dockerfile
          DIFF_OUTPUT=$(git diff HEAD -- "$dockerfile")
          
          if [ -z "$DIFF_OUTPUT" ]; then
            output "‚ö†Ô∏è No diff content found for $dockerfile"
            continue
          fi
          
          # Extract the old and new FROM lines
          OLD_FROM=$(echo "$DIFF_OUTPUT" | grep "^-FROM " | head -n1 | sed 's/^-FROM //')
          NEW_FROM=$(echo "$DIFF_OUTPUT" | grep "^+FROM " | head -n1 | sed 's/^\+FROM //')
          
          if [ -z "$OLD_FROM" ] || [ -z "$NEW_FROM" ]; then
            output "‚ö†Ô∏è Could not extract FROM lines from diff for $dockerfile"
            continue
          fi
          
          output "üîÑ Change detected:"
          output "  **Old:** \`$OLD_FROM\`"
          output "  **New:** \`$NEW_FROM\`"
          output ""
          
          if [ "$OLD_FROM" = "$NEW_FROM" ]; then
            output "‚ÑπÔ∏è No FROM line changes"
            continue
          fi
          
          output "| Aspect | Details |"
          output "|--------|---------|"
          output "| **Before** | \`$OLD_FROM\` |"
          output "| **After**  | \`$NEW_FROM\` |"
          output ""
          
          # Pull and scan old image
          output "üîç Scanning old image..."
          docker pull "$OLD_FROM" >/dev/null 2>&1 || { output "‚ùå Failed to pull $OLD_FROM"; continue; }
          OLD_SCAN=$(grype "$OLD_FROM" -o json -q 2>/dev/null)
          
          # Parse old CVE counts
          OLD_CRITICAL=$(echo "$OLD_SCAN" | jq '[.matches[] | select(.vulnerability.severity == "Critical")] | length')
          OLD_HIGH=$(echo "$OLD_SCAN" | jq '[.matches[] | select(.vulnerability.severity == "High")] | length')
          OLD_MEDIUM=$(echo "$OLD_SCAN" | jq '[.matches[] | select(.vulnerability.severity == "Medium")] | length')
          OLD_LOW=$(echo "$OLD_SCAN" | jq '[.matches[] | select(.vulnerability.severity == "Low")] | length')
          OLD_NEGLIGIBLE=$(echo "$OLD_SCAN" | jq '[.matches[] | select(.vulnerability.severity == "Negligible")] | length')
          OLD_UNKNOWN=$(echo "$OLD_SCAN" | jq '[.matches[] | select(.vulnerability.severity == "Unknown")] | length')
          OLD_TOTAL=$(echo "$OLD_SCAN" | jq '.matches | length')
          
          # Pull and scan new image
          output "üîç Scanning new image..."
          docker pull "$NEW_FROM" >/dev/null 2>&1 || { output "‚ùå Failed to pull $NEW_FROM"; continue; }
          NEW_SCAN=$(grype "$NEW_FROM" -o json -q 2>/dev/null)
          
          # Parse new CVE counts
          NEW_CRITICAL=$(echo "$NEW_SCAN" | jq '[.matches[] | select(.vulnerability.severity == "Critical")] | length')
          NEW_HIGH=$(echo "$NEW_SCAN" | jq '[.matches[] | select(.vulnerability.severity == "High")] | length')
          NEW_MEDIUM=$(echo "$NEW_SCAN" | jq '[.matches[] | select(.vulnerability.severity == "Medium")] | length')
          NEW_LOW=$(echo "$NEW_SCAN" | jq '[.matches[] | select(.vulnerability.severity == "Low")] | length')
          NEW_NEGLIGIBLE=$(echo "$NEW_SCAN" | jq '[.matches[] | select(.vulnerability.severity == "Negligible")] | length')
          NEW_UNKNOWN=$(echo "$NEW_SCAN" | jq '[.matches[] | select(.vulnerability.severity == "Unknown")] | length')
          NEW_TOTAL=$(echo "$NEW_SCAN" | jq '.matches | length')
          
          # Calculate differences
          TOTAL_DIFF=$((NEW_TOTAL - OLD_TOTAL))
          CRITICAL_DIFF=$((NEW_CRITICAL - OLD_CRITICAL))
          HIGH_DIFF=$((NEW_HIGH - OLD_HIGH))
          MEDIUM_DIFF=$((NEW_MEDIUM - OLD_MEDIUM))
          LOW_DIFF=$((NEW_LOW - OLD_LOW))
          NEGLIGIBLE_DIFF=$((NEW_NEGLIGIBLE - OLD_NEGLIGIBLE))
          UNKNOWN_DIFF=$((NEW_UNKNOWN - OLD_UNKNOWN))
          
          # Format difference helper
          format_diff() {
            local old=$1
            local new=$2
            local diff=$3
            if [ $diff -gt 0 ]; then
              echo "$old ‚Üí $new üî¥ (+$diff)"
            elif [ $diff -lt 0 ]; then
              echo "$old ‚Üí $new üü¢ ($diff)"
            else
              echo "$old ‚Üí $new ‚ö™ (0)"
            fi
          }
          
          output "### CVE Counts by Severity"
          output ""
          output "| Severity | Change |"
          output "|----------|--------|"
          output "| Critical | $(format_diff $OLD_CRITICAL $NEW_CRITICAL $CRITICAL_DIFF) |"
          output "| High     | $(format_diff $OLD_HIGH $NEW_HIGH $HIGH_DIFF) |"
          output "| Medium   | $(format_diff $OLD_MEDIUM $NEW_MEDIUM $MEDIUM_DIFF) |"
          output "| Low      | $(format_diff $OLD_LOW $NEW_LOW $LOW_DIFF) |"
          output "| Negligible | $(format_diff $OLD_NEGLIGIBLE $NEW_NEGLIGIBLE $NEGLIGIBLE_DIFF) |"
          output "| Unknown  | $(format_diff $OLD_UNKNOWN $NEW_UNKNOWN $UNKNOWN_DIFF) |"
          output "| **Total** | **$(format_diff $OLD_TOTAL $NEW_TOTAL $TOTAL_DIFF)** |"
          output ""
          
          # Assessment
          if [ $TOTAL_DIFF -lt 0 ]; then
            output "### ‚úÖ Assessment: IMPROVEMENT"
            output "Reduces CVE count by $((-TOTAL_DIFF))"
          elif [ $TOTAL_DIFF -gt 0 ]; then
            output "### ‚ö†Ô∏è Assessment: REGRESSION"
            output "Increases CVE count by $TOTAL_DIFF"
          else
            output "### ‚ö™ Assessment: NO CHANGE"
          fi
          
          CRITICAL_HIGH_DIFF=$((CRITICAL_DIFF + HIGH_DIFF))
          if [ $CRITICAL_HIGH_DIFF -lt 0 ]; then
            output ""
            output "**üéâ Critical/High CVEs reduced by $((-CRITICAL_HIGH_DIFF))**"
          elif [ $CRITICAL_HIGH_DIFF -gt 0 ]; then
            output ""
            output "**‚ö†Ô∏è Critical/High CVEs increased by $CRITICAL_HIGH_DIFF**"
          fi
          
          output ""
        done
        
        output "---"
        output ""
        output "‚úÖ CVE comparison complete"
